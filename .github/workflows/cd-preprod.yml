name: CD Preprod

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.github/workflows/cd-prod.yml'
      - '.github/workflows/deploy-manual.yml'

env:
  REGISTRY: ghcr.io
  DEPLOY_PATH: /home/deploy/I2F/PROJETS/LINKEDIN_COMMENTER/linkedin_commenter-v3

jobs:
  build-backend:
    runs-on: ubuntu-latest
    environment: preprod
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set image prefix (lowercase)
        run: |
          OWNER_LOWER=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')
          echo "IMAGE_PREFIX=${OWNER_LOWER}/linkedin-ai" >> $GITHUB_ENV
          echo "GITHUB_OWNER_LOWER=${OWNER_LOWER}" >> $GITHUB_ENV

      - name: Set environment variables
        run: |
          echo "AI_API_URL=${{ secrets.AI_API_URL_PREPROD }}" >> $GITHUB_ENV
          echo "USERS_API_URL=${{ secrets.USERS_API_URL_PREPROD }}" >> $GITHUB_ENV
          echo "SITE_URL=${{ secrets.SITE_URL_PREPROD }}" >> $GITHUB_ENV
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID_PREPROD }}" >> $GITHUB_ENV
          echo "GOOGLE_CLIENT_ID_WEB=${{ secrets.GOOGLE_CLIENT_ID_WEB_PREPROD }}" >> $GITHUB_ENV
          echo "STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET_PREPROD }}" >> $GITHUB_ENV

      - name: Apply environment config
        run: |
          chmod +x scripts/apply-env.sh
          ./scripts/apply-env.sh .

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push ai-service
        uses: docker/build-push-action@v5
        with:
          context: ./BACK-END/ai-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ai-service:preprod
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-ai-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push user-service
        uses: docker/build-push-action@v5
        with:
          context: ./BACK-END/user-service
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-user-service:preprod
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-user-service:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push website
        uses: docker/build-push-action@v5
        with:
          context: ./SITE-INTERNET
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-website:preprod
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build and push postgres
        uses: docker/build-push-action@v5
        with:
          context: ./BACK-END/database
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}-postgres:preprod
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Create .env and Deploy to Preprod VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST_PREPROD }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY_PREPROD }}
          script: |
            cd ${{ env.DEPLOY_PATH }}

            # Create/update .env file with all secrets
            cat > .env << 'ENVEOF'
            # === Registry ===
            GITHUB_OWNER=${{ env.GITHUB_OWNER_LOWER }}
            TAG=preprod

            # === Database ===
            POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }}

            # === Auth ===
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            JWT_ALGORITHM=HS256
            JWT_EXPIRATION_HOURS=24
            ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}

            # === Google OAuth ===
            GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID_PREPROD }}
            GOOGLE_CLIENT_ID_WEB=${{ secrets.GOOGLE_CLIENT_ID_WEB_PREPROD }}

            # === OpenAI ===
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}

            # === Stripe ===
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY_PREPROD }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET_PREPROD }}
            STRIPE_PRICE_MEDIUM_MONTHLY=${{ secrets.STRIPE_PRICE_MEDIUM_MONTHLY }}
            STRIPE_PRICE_PREMIUM_MONTHLY=${{ secrets.STRIPE_PRICE_PREMIUM_MONTHLY }}
            STRIPE_SUCCESS_URL=${{ secrets.SITE_URL_PREPROD }}/success?session_id={CHECKOUT_SESSION_ID}
            STRIPE_CANCEL_URL=${{ secrets.SITE_URL_PREPROD }}/cancel
            STRIPE_PORTAL_RETURN_URL=${{ secrets.SITE_URL_PREPROD }}/account/subscription

            # === CORS ===
            ALLOWED_ORIGINS=${{ secrets.AI_API_URL_PREPROD }},${{ secrets.USERS_API_URL_PREPROD }},${{ secrets.SITE_URL_PREPROD }},chrome-extension://*
            CORS_CREDENTIALS=true

            # === Traefik Hosts ===
            AI_API_HOST=ai.api.ai-linkedin.iry-entreprise.fr
            USERS_API_HOST=users.api.ai-linkedin.iry-entreprise.fr
            SITE_HOST=ai-linkedin.iry-entreprise.fr

            # === PostHog (disabled) ===
            POSTHOG_ENABLED=false
            POSTHOG_API_KEY=
            POSTHOG_HOST=https://eu.i.posthog.com

            # === Environment ===
            ENVIRONMENT=preprod
            ENVEOF

            echo ".env file created successfully"

            # Login GHCR
            echo ${{ secrets.GHCR_PAT }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

            # Pull et redemarrer
            docker compose pull
            docker compose up -d --remove-orphans
            docker system prune -f

            echo "Preprod deployed successfully - $(date)"

  build-extension:
    runs-on: ubuntu-latest
    environment: preprod

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set environment variables
        run: |
          echo "AI_API_URL=${{ secrets.AI_API_URL_PREPROD }}" >> $GITHUB_ENV
          echo "USERS_API_URL=${{ secrets.USERS_API_URL_PREPROD }}" >> $GITHUB_ENV
          echo "SITE_URL=${{ secrets.SITE_URL_PREPROD }}" >> $GITHUB_ENV
          echo "GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID_PREPROD }}" >> $GITHUB_ENV

      - name: Apply environment config to extension
        run: |
          chmod +x scripts/apply-env.sh
          ./scripts/apply-env.sh ./FRONT-END

      - name: Package Chrome Extension
        run: |
          cd FRONT-END
          zip -r ../extension-preprod.zip . -x "*.git*" -x "*.DS_Store" -x "*.env*"

      - name: Upload to Chrome Web Store
        id: chrome-upload
        continue-on-error: true
        uses: mnao305/chrome-extension-upload@v5.0.0
        with:
          file-path: extension-preprod.zip
          extension-id: ${{ secrets.CHROME_EXTENSION_ID_PREPROD }}
          client-id: ${{ secrets.CHROME_CLIENT_ID }}
          client-secret: ${{ secrets.CHROME_CLIENT_SECRET }}
          refresh-token: ${{ secrets.CHROME_REFRESH_TOKEN }}

      - name: Chrome Web Store Upload Status
        run: |
          if [ "${{ steps.chrome-upload.outcome }}" == "failure" ]; then
            echo "::warning::Chrome Web Store upload failed (expected for preprod - publish not enabled)"
          else
            echo "Chrome Web Store upload successful"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-preprod-${{ github.sha }}
          path: extension-preprod.zip
          retention-days: 30

  notify:
    needs: [build-backend, build-extension]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "## Preprod Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ needs.build-backend.result == 'success' && 'Deployed' || 'Failed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Extension**: ${{ needs.build-extension.result == 'success' && 'Uploaded (not published)' || 'Failed' }}" >> $GITHUB_STEP_SUMMARY
